<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Pubblibike2maps</title>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_h4M1artOPPisDDhpabx4OtwOckWh9M8&libraries=places&callback=initAutocomplete"></script>
  </head>
  <body>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <div>Find direction to a place with a stop at the nearest pubblibike location</div>
      <div><input id="query" type="text" placeholder="Search place..." style="width: 90%" /></div>
      <div id="results"></div>
    </div>
    <script>
      let cachedStations = null;
      let autocomplete = null;
      async function getStations() {
        if (!cachedStations) {
          cachedStations = await fetch("https://getstations-bp5bh5ciwq-uc.a.run.app/")
            .then((response) => response.json())
            .catch((error) => console.error(error));
        }
        return cachedStations;
      }
      function dist(lat1, lon1, lat2, lon2) {
        var R = 6371e3;
        var φ1 = (lat1 * Math.PI) / 180;
        var φ2 = (lat2 * Math.PI) / 180;
        var Δφ = ((lat2 - lat1) * Math.PI) / 180;
        var Δλ = ((lon2 - lon1) * Math.PI) / 180;
        var a =
          Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
          Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
      async function onPlaceChanged(startPos) {
        document.getElementById("results").innerHTML = "Loading...";
        var place = autocomplete.getPlace();
        var lat = place.geometry.location.lat();
        var lng = place.geometry.location.lng();
        getStations()
          .then((r) => {
            const nearest = r
              .map((s) => ({
                station: s,
                distance: dist(lat, lng, s.latitude, s.longitude),
              }))
              .reduce((a, v) => (a.distance < v.distance ? a : v)).station;
            const url = `https://www.google.com/maps/dir/${startPos.latitude},${startPos.longitude}/${nearest.latitude},${nearest.longitude}/${lat},${lng}/data=!3m1!4b1!4m2!4m1!3e1?entry=ttu`;
            document.getElementById("results").innerHTML = `<a href="${url}">${url}</a>`;
          })
          .catch((e) => {
            document.getElementById("results").innerHTML = `ERROR: ${e}`;
          });
      }
      function initAutocomplete() {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            autocomplete = new google.maps.places.Autocomplete(
              document.getElementById("query"),
              {
                bounds: new google.maps.LatLngBounds(
                  new google.maps.LatLng(position.coords.latitude - 0.1, position.coords.longitude - 0.1),
                  new google.maps.LatLng(position.coords.latitude + 0.1, position.coords.longitude + 0.1)
                ),
                strictBounds: false,
                types: ["establishment"],
                componentRestrictions: { country: ["ch"] },
                fields: ["place_id", "geometry", "name"],
              }
            );
            autocomplete.addListener("place_changed", () => onPlaceChanged(position.coords));
          },
          (e) => alert("ERROR:" + e.message)
        );
      }
    </script>
  </body>
</html>
